import{_ as L,u as U,s as F,r as u,w as I,E as V,o as q,a as H,b as v,c as G,d as K,e as Q,f,g as X,h as Y,i as Z,F as ee,j as ae,k as te}from"./index-Cd0LJEJn.js";import{u as se,p as re}from"./useWidget-gUdKlkzY.js";import{l as oe}from"./lodash-B35L66LH.js";const ie={style:{display:"flex","justify-content":"space-between"}},ne={__name:"areamap-widget",props:{widgetObj:{type:Object,required:!0}},async setup(b){var y,h,M,_,x,$,k;let O,j;const D=U(),{curWrapper:E,dark:le}=F(D),s=b,C=u(),S=u(!1),{loadRemoteData:z}=se(s.widgetObj,s.widgetObj.widgetParams[0].typeOptions.dataJson,C,S);[O,j]=I(()=>z()),await O,j();const P=u("330000");P.value=(y=s.widgetObj.widgetParams[1])==null?void 0:y.value;const c=u(null);let i=null,m=[];const w=u(null),l=u({tooltip:{trigger:"item",formatter:e=>{var a;return e.seriesType==="lines"?`${e.data.fromName} -> ${e.data.toName}`:`${e.name}<br>${(a=s.widgetObj.widgetParams[3])==null?void 0:a.value}：${Array.isArray(e.value)?e.value[2]:e.value}`}},visualMap:{show:!0,min:(h=s.widgetObj.widgetParams[4])==null?void 0:h.value,max:(M=s.widgetObj.widgetParams[5])==null?void 0:M.value,inRange:{color:(x=(_=s.widgetObj.widgetParams[6])==null?void 0:_.value)==null?void 0:x.split(",")},calculable:!0,right:10,bottom:30},geo:{label:{normal:{show:!0,formatter:e=>{const a=l.value.series[0].data.find(t=>t.name===e.name);return`${e.name}：${a?a.value:0}`},position:"right",textStyle:{color:($=s.widgetObj.widgetParams[7])==null?void 0:$.value,fontSize:(k=s.widgetObj.widgetParams[8])==null?void 0:k.value}}},roam:!0},series:[{type:"map",geoIndex:0}]});async function J(e){var a,t;try{let r=`${(a=s.widgetObj.widgetParams[10])==null?void 0:a.value}/${(t=s.widgetObj.widgetParams[1])==null?void 0:t.value}/${e}.json`;console.log("newJsonUrl",r);const o=await fetch(r);if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);const n=await o.json();return w.value=n,w.value}catch(r){return console.error(`加载${e}地图数据失败:`,r),null}}async function d(e){const a=await J(e);if(!a)return;m=[],a.features.forEach(o=>{m.push({name:o.properties.name,adcode:o.properties.adcode})}),P.value=e,ae(e,a),l.value.geo.map=e,l.value.series[0].map=e;const{features:t}=w.value,r=N(t);l.value.series[0].data=r.areaData,i&&i.setOption(l.value,!0)}function N(e){var r;let a=[],t=[];return(r=s.widgetObj.widgetParams[9])!=null&&r.value?e.forEach((o,n)=>{const p=o.properties,A=Math.round(Math.random()*100);a.push({name:p.name,value:A})}):a=s.widgetObj.widgetParams[0].typeOptions.dataJson,{areaData:a,scatterData:t}}const B=oe.debounce(async e=>{var a,t,r,o;if(e.path=(a=s.widgetObj.widgetParams[12])==null?void 0:a.value,console.log("防抖触发",e),(t=s.widgetObj.widgetParams[11])!=null&&t.value)try{const n=await re((r=s.widgetObj.widgetParams[11])==null?void 0:r.value,e);n&&n.length>0&&console.log("任务更新到接口",n)}catch(n){console.error("任务更新失败:",n)}V.emit("areaMapClick",e),(o=window.parent)==null||o.postMessage({key:"areaMapWidget",value:JSON.stringify(e)},"*")},500);async function R(e){var t;const a=m.find(r=>r.name===e.name);a&&(console.log("实际点击",a),(t=s.widgetObj.widgetParams[2])!=null&&t.value&&d(a.adcode),await B(a))}function T(){var e;c.value&&(i=te(c.value),d((e=s.widgetObj.widgetParams[1])==null?void 0:e.value),i.on("click",R),window.addEventListener("resize",g))}q(()=>{i&&(i.dispose(),i=null),window.removeEventListener("resize",g)}),H(()=>{T()});function g(){i&&(i==null||i.resize())}function W(e){var a,t,r,o,n,p;l.value.visualMap.min=(a=e.widgetParams[4])==null?void 0:a.value,l.value.visualMap.max=(t=e.widgetParams[5])==null?void 0:t.value,l.value.visualMap.inRange.color=(o=(r=e.widgetParams[6])==null?void 0:r.value)==null?void 0:o.split(","),l.value.geo.label.normal.textStyle={color:(n=e.widgetParams[7])==null?void 0:n.value,fontSize:(p=e.widgetParams[8])==null?void 0:p.value},i&&i.setOption(l.value,!0),g()}return v(()=>s.widgetObj,(e,a)=>{W(e)},{deep:!0}),v(()=>s.widgetObj.widgetParams[0].typeOptions.dataJson,(e,a)=>{var t;e!=a&&d((t=s.widgetObj.widgetParams[1])==null?void 0:t.value)},{deep:!0}),v(()=>E.value,(e,a)=>{g()},{deep:!0}),(e,a)=>{const t=G("el-button");return K(),Q(ee,null,[f("div",ie,[f("div",null,[X(t,{onClick:a[0]||(a[0]=r=>{var o;return d((o=b.widgetObj.widgetParams[1])==null?void 0:o.value)})},{default:Y(()=>a[1]||(a[1]=[Z("初始化地图")])),_:1})])]),f("div",{class:"overview_main_mapBox",id:"mapChart",ref_key:"mapChart",ref:c},null,512)],64)}}},pe=L(ne,[["__scopeId","data-v-560ccd90"]]);export{pe as default};
