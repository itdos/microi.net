import{_ as L,u as U,s as F,r as u,w as I,E as V,o as q,a as H,b as v,c as G,d as K,e as Q,f,g as X,h as Y,i as Z,F as ee,j as ae,k as te}from"./index-B5w5yjo2.js";import{u as re}from"./useWidget-DmJgHqlZ.js";import{p as se}from"./axiosInstance-DvXOrD9J.js";import{l as ie}from"./lodash-N6Eh__xa.js";const oe={style:{display:"flex","justify-content":"space-between"}},ne={__name:"areamap-widget",props:{widgetObj:{type:Object,required:!0}},async setup(b){var h,y,M,_,x,$,k;let O,j;const D=U(),{curWrapper:E,dark:le}=F(D),s=b,C=u(),S=u(!1),{loadRemoteData:z}=re(s.widgetObj,s.widgetObj.widgetParams[0].typeOptions.dataJson,C,S);[O,j]=I(()=>z()),await O,j();const P=u("330000");P.value=(h=s.widgetObj.widgetParams[1])==null?void 0:h.value;const c=u(null);let o=null,m=[];const w=u(null),n=u({tooltip:{trigger:"item",formatter:e=>{var a;return e.seriesType==="lines"?`${e.data.fromName} -> ${e.data.toName}`:`${e.name}<br>${(a=s.widgetObj.widgetParams[3])==null?void 0:a.value}：${Array.isArray(e.value)?e.value[2]:e.value}`}},visualMap:{show:!0,min:(y=s.widgetObj.widgetParams[4])==null?void 0:y.value,max:(M=s.widgetObj.widgetParams[5])==null?void 0:M.value,inRange:{color:(x=(_=s.widgetObj.widgetParams[6])==null?void 0:_.value)==null?void 0:x.split(",")},calculable:!0,right:10,bottom:30},geo:{label:{normal:{show:!0,formatter:e=>{const a=n.value.series[0].data.find(r=>r.name===e.name);return`${e.name}：${a?a.value:0}`},position:"right",textStyle:{color:($=s.widgetObj.widgetParams[7])==null?void 0:$.value,fontSize:(k=s.widgetObj.widgetParams[8])==null?void 0:k.value}}},roam:!0},series:[{type:"map",geoIndex:0}]});async function J(e){var a,r;try{let i=`${(a=s.widgetObj.widgetParams[10])==null?void 0:a.value}/${(r=s.widgetObj.widgetParams[1])==null?void 0:r.value}/${e}.json`;console.log("newJsonUrl",i);const t=await fetch(i);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const l=await t.json();return w.value=l,w.value}catch(i){return console.error(`加载${e}地图数据失败:`,i),null}}async function d(e){const a=await J(e);if(!a)return;m=[],a.features.forEach(t=>{m.push({name:t.properties.name,adcode:t.properties.adcode})}),P.value=e,ae(e,a),n.value.geo.map=e,n.value.series[0].map=e;const{features:r}=w.value,i=N(r);n.value.series[0].data=i.areaData,o&&o.setOption(n.value,!0)}function N(e){var i;let a=[],r=[];return(i=s.widgetObj.widgetParams[9])!=null&&i.value?e.forEach((t,l)=>{const g=t.properties,A=Math.round(Math.random()*100);a.push({name:g.name,value:A})}):a=s.widgetObj.widgetParams[0].typeOptions.dataJson,{areaData:a,scatterData:r}}const B=ie.debounce(async e=>{var a,r,i;if(console.log("防抖触发",e),(a=s.widgetObj.widgetParams[11])!=null&&a.value)try{const t=await se((r=s.widgetObj.widgetParams[11])==null?void 0:r.value,e);t&&t.length>0&&console.log("任务更新到接口",t)}catch(t){console.error("任务更新失败:",t)}V.emit("areaMapClick",e),(i=window.parent)==null||i.postMessage({key:"areaMapWidget",value:JSON.stringify(e)},"*")},500);async function R(e){var r,i,t;const a=m.find(l=>l.name===e.name);a&&(a.path=(r=s.widgetObj.widgetParams[12])==null?void 0:r.value,(i=e.data)!=null&&i.path&&(a.path=e.data.path),(t=s.widgetObj.widgetParams[2])!=null&&t.value&&d(a.adcode),await B(a))}function T(){var e;c.value&&(o=te(c.value),d((e=s.widgetObj.widgetParams[13])==null?void 0:e.value),o.on("click",R),window.addEventListener("resize",p))}q(()=>{o&&(o.dispose(),o=null),window.removeEventListener("resize",p)}),H(()=>{T()});function p(){o&&(o==null||o.resize())}function W(e){var a,r,i,t,l,g;n.value.visualMap.min=(a=e.widgetParams[4])==null?void 0:a.value,n.value.visualMap.max=(r=e.widgetParams[5])==null?void 0:r.value,n.value.visualMap.inRange.color=(t=(i=e.widgetParams[6])==null?void 0:i.value)==null?void 0:t.split(","),n.value.geo.label.normal.textStyle={color:(l=e.widgetParams[7])==null?void 0:l.value,fontSize:(g=e.widgetParams[8])==null?void 0:g.value},o&&o.setOption(n.value,!0),p()}return v(()=>s.widgetObj,(e,a)=>{W(e)},{deep:!0}),v(()=>s.widgetObj.widgetParams[0].typeOptions.dataJson,(e,a)=>{var r;e!=a&&d((r=s.widgetObj.widgetParams[1])==null?void 0:r.value)},{deep:!0}),v(()=>E.value,(e,a)=>{p()},{deep:!0}),(e,a)=>{const r=G("el-button");return K(),Q(ee,null,[f("div",oe,[f("div",null,[X(r,{onClick:a[0]||(a[0]=i=>{var t;return d((t=b.widgetObj.widgetParams[13])==null?void 0:t.value)})},{default:Y(()=>a[1]||(a[1]=[Z("初始化地图")])),_:1})])]),f("div",{class:"overview_main_mapBox",id:"mapChart",ref_key:"mapChart",ref:c},null,512)],64)}}},ce=L(ne,[["__scopeId","data-v-e7ac2f90"]]);export{ce as default};
