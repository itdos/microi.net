import{_ as L,u as U,s as F,r as l,w as I,E as V,o as q,a as H,b as v,c as G,d as K,e as Q,f,g as X,h as Y,i as Z,F as ee,j as ae,k as te}from"./index-DvqzQtZ1.js";import{u as se,p as re}from"./useWidget-B9Tp2iib.js";import{l as oe}from"./lodash-CuYyFUp5.js";const ie={style:{display:"flex","justify-content":"space-between"}},ne={__name:"areamap-widget",props:{widgetObj:{type:Object,required:!0}},async setup(b){var y,h,M,_,x,$,k;let O,j;const D=U(),{curWrapper:E,dark:le}=F(D),s=b,C=l(),S=l(!1),{loadRemoteData:z}=se(s.widgetObj,s.widgetObj.widgetParams[0].typeOptions.dataJson,C,S);[O,j]=I(()=>z()),await O,j();const P=l("330000");P.value=(y=s.widgetObj.widgetParams[1])==null?void 0:y.value;const c=l(null);let i=null,m=[];const w=l(null),n=l({tooltip:{trigger:"item",formatter:e=>{var a;return e.seriesType==="lines"?`${e.data.fromName} -> ${e.data.toName}`:`${e.name}<br>${(a=s.widgetObj.widgetParams[3])==null?void 0:a.value}：${Array.isArray(e.value)?e.value[2]:e.value}`}},visualMap:{show:!0,min:(h=s.widgetObj.widgetParams[4])==null?void 0:h.value,max:(M=s.widgetObj.widgetParams[5])==null?void 0:M.value,inRange:{color:(x=(_=s.widgetObj.widgetParams[6])==null?void 0:_.value)==null?void 0:x.split(",")},calculable:!0,right:10,bottom:30},geo:{label:{normal:{show:!0,formatter:e=>{const a=n.value.series[0].data.find(t=>t.name===e.name);return`${e.name}：${a?a.value:0}`},position:"right",textStyle:{color:($=s.widgetObj.widgetParams[7])==null?void 0:$.value,fontSize:(k=s.widgetObj.widgetParams[8])==null?void 0:k.value}}},roam:!0},series:[{type:"map",geoIndex:0}]});async function J(e){var a,t;try{let o=`${(a=s.widgetObj.widgetParams[10])==null?void 0:a.value}/${(t=s.widgetObj.widgetParams[1])==null?void 0:t.value}/${e}.json`;console.log("newJsonUrl",o);const r=await fetch(o);if(!r.ok)throw new Error(`HTTP error! Status: ${r.status}`);const u=await r.json();return w.value=u,w.value}catch(o){return console.error(`加载${e}地图数据失败:`,o),null}}async function d(e){const a=await J(e);if(!a)return;m=[],a.features.forEach(r=>{m.push({name:r.properties.name,adcode:r.properties.adcode})}),P.value=e,ae(e,a),n.value.geo.map=e,n.value.series[0].map=e;const{features:t}=w.value,o=N(t);n.value.series[0].data=o.areaData,i&&i.setOption(n.value,!0)}function N(e){var o;let a=[],t=[];return(o=s.widgetObj.widgetParams[9])!=null&&o.value?e.forEach((r,u)=>{const p=r.properties,A=Math.round(Math.random()*100);a.push({name:p.name,value:A})}):a=s.widgetObj.widgetParams[0].typeOptions.dataJson,{areaData:a,scatterData:t}}const B=oe.debounce(async e=>{var a,t,o;if(console.log("防抖触发",e),(a=s.widgetObj.widgetParams[11])!=null&&a.value)try{const r=await re((t=s.widgetObj.widgetParams[11])==null?void 0:t.value,e);r&&r.length>0&&console.log("任务更新到接口",r)}catch(r){console.error("任务更新失败:",r)}V.emit("areaMapClick",e),(o=window.parent)==null||o.postMessage({key:"areaMapWidget",value:JSON.stringify(e)},"*")},500);async function R(e){var t;const a=m.find(o=>o.name===e.name);a&&(console.log("实际点击",a),(t=s.widgetObj.widgetParams[2])!=null&&t.value&&d(a.adcode),await B(a))}function T(){var e;c.value&&(i=te(c.value),d((e=s.widgetObj.widgetParams[1])==null?void 0:e.value),i.on("click",R),window.addEventListener("resize",g))}q(()=>{i&&(i.dispose(),i=null),window.removeEventListener("resize",g)}),H(()=>{T()});function g(){i&&(i==null||i.resize())}function W(e){var a,t,o,r,u,p;n.value.visualMap.min=(a=e.widgetParams[4])==null?void 0:a.value,n.value.visualMap.max=(t=e.widgetParams[5])==null?void 0:t.value,n.value.visualMap.inRange.color=(r=(o=e.widgetParams[6])==null?void 0:o.value)==null?void 0:r.split(","),n.value.geo.label.normal.textStyle={color:(u=e.widgetParams[7])==null?void 0:u.value,fontSize:(p=e.widgetParams[8])==null?void 0:p.value},i&&i.setOption(n.value,!0),g()}return v(()=>s.widgetObj,(e,a)=>{W(e)},{deep:!0}),v(()=>s.widgetObj.widgetParams[0].typeOptions.dataJson,(e,a)=>{var t;e!=a&&d((t=s.widgetObj.widgetParams[1])==null?void 0:t.value)},{deep:!0}),v(()=>E.value,(e,a)=>{g()},{deep:!0}),(e,a)=>{const t=G("el-button");return K(),Q(ee,null,[f("div",ie,[f("div",null,[X(t,{onClick:a[0]||(a[0]=o=>{var r;return d((r=b.widgetObj.widgetParams[1])==null?void 0:r.value)})},{default:Y(()=>a[1]||(a[1]=[Z("初始化地图")])),_:1})])]),f("div",{class:"overview_main_mapBox",id:"mapChart",ref_key:"mapChart",ref:c},null,512)],64)}}},pe=L(ne,[["__scopeId","data-v-246d335e"]]);export{pe as default};
