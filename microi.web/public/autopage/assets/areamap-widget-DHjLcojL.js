import{r as F,i as V}from"./index-C2kp-yMC.js";import{u as q}from"./useWidget-Db2vkJc0.js";import{_ as H,u as G,s as K,r as u,w as Q,E as X,o as Y,a as Z,b as f,c as ee,d as te,e as ae,f as b,g as oe,h as se,i as re,F as ie}from"./index-Dj9Hm9aG.js";import{p as ne}from"./axiosInstance-BVo9fqmq.js";import{l as le}from"./lodash-BHo67SWd.js";const ue={style:{display:"flex","justify-content":"space-between"}},de={__name:"areamap-widget",props:{widgetObj:{type:Object,required:!0}},async setup(O){var y,M,_,x,$,D,E;let j,P;const k=G(),{curWrapper:C,dark:pe}=K(k),s=O,S=u(),z=u(!1),{loadRemoteData:T}=q(s.widgetObj,s.widgetObj.widgetParams[0].typeOptions.dataJson,S,z);[j,P]=Q(()=>T()),await j,P();const h=u("330000");h.value=(y=s.widgetObj.widgetParams[1])==null?void 0:y.value;const g=u(null);let i=null,m=[];const w=u(null),n=u({tooltip:{trigger:"item",formatter:e=>{var t;return e.seriesType==="lines"?`${e.data.fromName} -> ${e.data.toName}`:`${e.name}<br>${(t=s.widgetObj.widgetParams[3])==null?void 0:t.value}：${Array.isArray(e.value)?e.value[2]:e.value}`}},visualMap:{show:!0,min:(M=s.widgetObj.widgetParams[4])==null?void 0:M.value,max:(_=s.widgetObj.widgetParams[5])==null?void 0:_.value,inRange:{color:($=(x=s.widgetObj.widgetParams[6])==null?void 0:x.value)==null?void 0:$.split(",")},calculable:!0,right:10,bottom:30},geo:{label:{normal:{show:!0,formatter:e=>{const t=n.value.series[0].data.find(a=>a.name===e.name);return`${e.name}：${t?t.value:0}`},position:"right",textStyle:{color:(D=s.widgetObj.widgetParams[7])==null?void 0:D.value,fontSize:(E=s.widgetObj.widgetParams[8])==null?void 0:E.value}}},roam:!0},series:[{type:"map",geoIndex:0}]});async function J(e){var t,a;try{let r=`${(t=s.widgetObj.widgetParams[10])==null?void 0:t.value}/${(a=s.widgetObj.widgetParams[1])==null?void 0:a.value}/${e}.json`;console.log("newJsonUrl",r);const o=await fetch(r);if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);const l=await o.json();return w.value=l,w.value}catch(r){return console.error(`加载${e}地图数据失败:`,r),null}}async function d(e){const t=await J(e);if(!t)return;m=[],t.features.forEach(o=>{m.push({name:o.properties.name,adcode:o.properties.adcode})}),h.value=e,F(e,t),n.value.geo.map=e,n.value.series[0].map=e;const{features:a}=w.value,r=N(a);n.value.series[0].data=r.areaData,i&&i.setOption(n.value,!0)}function N(e){var r;let t=[],a=[];return(r=s.widgetObj.widgetParams[9])!=null&&r.value?e.forEach((o,l)=>{const c=o.properties,L=Math.round(Math.random()*100);t.push({name:c.name,value:L})}):t=s.widgetObj.widgetParams[0].typeOptions.dataJson,{areaData:t,scatterData:a}}const R=le.debounce(async e=>{var t,a,r;if(console.log("防抖触发",e),(t=s.widgetObj.widgetParams[11])!=null&&t.value)try{const o=await ne((a=s.widgetObj.widgetParams[11])==null?void 0:a.value,e);o&&o.length>0&&console.log("任务更新到接口",o)}catch(o){console.error("任务更新失败:",o)}X.emit(" ",e),(r=window.parent)==null||r.postMessage({key:"areaMapWidget",value:JSON.stringify(e)},"*")},500);async function B(e){var a,r,o;const t=m.find(l=>l.name===e.name);t&&(t.path=(a=s.widgetObj.widgetParams[12])==null?void 0:a.value,(r=e.data)!=null&&r.path&&(t.path=e.data.path),(o=s.widgetObj.widgetParams[2])!=null&&o.value&&d(t.adcode),await R(t))}function U(){var e;g.value&&(i=V(g.value),d((e=s.widgetObj.widgetParams[13])==null?void 0:e.value),i.on("click",B),window.addEventListener("resize",p))}Y(()=>{i&&(i.dispose(),i=null),window.removeEventListener("resize",p)}),Z(()=>{U()});function p(){i&&(i==null||i.resize())}const v=(e,t)=>{let a;return function(...r){clearTimeout(a),a=setTimeout(()=>e.apply(this,r),t)}},W=v(e=>{var t,a,r,o,l,c;n.value.visualMap.min=(t=e.widgetParams[4])==null?void 0:t.value,n.value.visualMap.max=(a=e.widgetParams[5])==null?void 0:a.value,n.value.visualMap.inRange.color=(o=(r=e.widgetParams[6])==null?void 0:r.value)==null?void 0:o.split(","),n.value.geo.label.normal.textStyle={color:(l=e.widgetParams[7])==null?void 0:l.value,fontSize:(c=e.widgetParams[8])==null?void 0:c.value},i&&i.setOption(n.value,!0),p()},1e3),A=v(e=>{d(e)},1e3),I=v(()=>{p()},1e3);return f(()=>s.widgetObj,(e,t)=>{W(e)},{deep:!0}),f(()=>s.widgetObj.widgetParams[0].typeOptions.dataJson,(e,t)=>{var a;e!=t&&A((a=s.widgetObj.widgetParams[1])==null?void 0:a.value)},{deep:!0}),f(()=>C.value,(e,t)=>{I()},{deep:!0}),(e,t)=>{const a=ee("el-button");return te(),ae(ie,null,[b("div",ue,[b("div",null,[oe(a,{onClick:t[0]||(t[0]=r=>{var o;return d((o=O.widgetObj.widgetParams[13])==null?void 0:o.value)})},{default:se(()=>t[1]||(t[1]=[re("初始化地图")])),_:1})])]),b("div",{class:"overview_main_mapBox",id:"mapChart",ref_key:"mapChart",ref:g},null,512)],64)}}},fe=H(de,[["__scopeId","data-v-2d65edd9"]]);export{fe as default};
