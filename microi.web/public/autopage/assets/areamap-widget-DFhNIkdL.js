import{r as L,i as U}from"./index-C2kp-yMC.js";import{u as F}from"./useWidget-DdzwJ3mM.js";import{_ as I,u as V,s as q,r as u,w as H,E as G,o as K,a as Q,b as v,c as X,d as Y,e as Z,f,g as ee,h as ae,i as te,F as re}from"./index-DE0aEFkh.js";import{p as ie}from"./axiosInstance-BYAPDAHk.js";import{l as se}from"./lodash-tpHLWD_i.js";const oe={style:{display:"flex","justify-content":"space-between"}},ne={__name:"areamap-widget",props:{widgetObj:{type:Object,required:!0}},async setup(b){var h,y,_,M,x,$,D;let O,j;const E=V(),{curWrapper:k,dark:le}=q(E),i=b,C=u(),S=u(!1),{loadRemoteData:z}=F(i.widgetObj,i.widgetObj.widgetParams[0].typeOptions.dataJson,C,S);[O,j]=H(()=>z()),await O,j();const P=u("330000");P.value=(h=i.widgetObj.widgetParams[1])==null?void 0:h.value;const c=u(null);let o=null,m=[];const w=u(null),n=u({tooltip:{trigger:"item",formatter:e=>{var a;return e.seriesType==="lines"?`${e.data.fromName} -> ${e.data.toName}`:`${e.name}<br>${(a=i.widgetObj.widgetParams[3])==null?void 0:a.value}：${Array.isArray(e.value)?e.value[2]:e.value}`}},visualMap:{show:!0,min:(y=i.widgetObj.widgetParams[4])==null?void 0:y.value,max:(_=i.widgetObj.widgetParams[5])==null?void 0:_.value,inRange:{color:(x=(M=i.widgetObj.widgetParams[6])==null?void 0:M.value)==null?void 0:x.split(",")},calculable:!0,right:10,bottom:30},geo:{label:{normal:{show:!0,formatter:e=>{const a=n.value.series[0].data.find(r=>r.name===e.name);return`${e.name}：${a?a.value:0}`},position:"right",textStyle:{color:($=i.widgetObj.widgetParams[7])==null?void 0:$.value,fontSize:(D=i.widgetObj.widgetParams[8])==null?void 0:D.value}}},roam:!0},series:[{type:"map",geoIndex:0}]});async function J(e){var a,r;try{let s=`${(a=i.widgetObj.widgetParams[10])==null?void 0:a.value}/${(r=i.widgetObj.widgetParams[1])==null?void 0:r.value}/${e}.json`;console.log("newJsonUrl",s);const t=await fetch(s);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const l=await t.json();return w.value=l,w.value}catch(s){return console.error(`加载${e}地图数据失败:`,s),null}}async function d(e){const a=await J(e);if(!a)return;m=[],a.features.forEach(t=>{m.push({name:t.properties.name,adcode:t.properties.adcode})}),P.value=e,L(e,a),n.value.geo.map=e,n.value.series[0].map=e;const{features:r}=w.value,s=N(r);n.value.series[0].data=s.areaData,o&&o.setOption(n.value,!0)}function N(e){var s;let a=[],r=[];return(s=i.widgetObj.widgetParams[9])!=null&&s.value?e.forEach((t,l)=>{const g=t.properties,A=Math.round(Math.random()*100);a.push({name:g.name,value:A})}):a=i.widgetObj.widgetParams[0].typeOptions.dataJson,{areaData:a,scatterData:r}}const B=se.debounce(async e=>{var a,r,s;if(console.log("防抖触发",e),(a=i.widgetObj.widgetParams[11])!=null&&a.value)try{const t=await ie((r=i.widgetObj.widgetParams[11])==null?void 0:r.value,e);t&&t.length>0&&console.log("任务更新到接口",t)}catch(t){console.error("任务更新失败:",t)}G.emit(" ",e),(s=window.parent)==null||s.postMessage({key:"areaMapWidget",value:JSON.stringify(e)},"*")},500);async function R(e){var r,s,t;const a=m.find(l=>l.name===e.name);a&&(a.path=(r=i.widgetObj.widgetParams[12])==null?void 0:r.value,(s=e.data)!=null&&s.path&&(a.path=e.data.path),(t=i.widgetObj.widgetParams[2])!=null&&t.value&&d(a.adcode),await B(a))}function T(){var e;c.value&&(o=U(c.value),d((e=i.widgetObj.widgetParams[13])==null?void 0:e.value),o.on("click",R),window.addEventListener("resize",p))}K(()=>{o&&(o.dispose(),o=null),window.removeEventListener("resize",p)}),Q(()=>{T()});function p(){o&&(o==null||o.resize())}function W(e){var a,r,s,t,l,g;n.value.visualMap.min=(a=e.widgetParams[4])==null?void 0:a.value,n.value.visualMap.max=(r=e.widgetParams[5])==null?void 0:r.value,n.value.visualMap.inRange.color=(t=(s=e.widgetParams[6])==null?void 0:s.value)==null?void 0:t.split(","),n.value.geo.label.normal.textStyle={color:(l=e.widgetParams[7])==null?void 0:l.value,fontSize:(g=e.widgetParams[8])==null?void 0:g.value},o&&o.setOption(n.value,!0),p()}return v(()=>i.widgetObj,(e,a)=>{W(e)},{deep:!0}),v(()=>i.widgetObj.widgetParams[0].typeOptions.dataJson,(e,a)=>{var r;e!=a&&d((r=i.widgetObj.widgetParams[1])==null?void 0:r.value)},{deep:!0}),v(()=>k.value,(e,a)=>{p()},{deep:!0}),(e,a)=>{const r=X("el-button");return Y(),Z(re,null,[f("div",oe,[f("div",null,[ee(r,{onClick:a[0]||(a[0]=s=>{var t;return d((t=b.widgetObj.widgetParams[13])==null?void 0:t.value)})},{default:ae(()=>a[1]||(a[1]=[te("初始化地图")])),_:1})])]),f("div",{class:"overview_main_mapBox",id:"mapChart",ref_key:"mapChart",ref:c},null,512)],64)}}},me=I(ne,[["__scopeId","data-v-a81ad517"]]);export{me as default};
