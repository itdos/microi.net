<template>
    <div id="diy-table" class="pluginPage">
        <el-tabs id="table-rowlist-tabs" v-model="DiyFormEngineTab" :class="'table-rowlist-tabs box-card-top-tabs'">
            <el-tab-pane :name="'Table'">
                <template #label>
                    <span
                        ><el-icon><Grid /></el-icon> 表单</span
                    >
                </template>
                <el-row>
                    <el-col :span="24">
                        <el-card class="box-card no-padding-body">
                            <el-form :model="SearchModel" inline @submit.prevent class="keyword-search">
                                <el-form-item :label="$t('Msg.Keyword')">
                                    <el-button type="primary" :icon="Plus" @click="OpenDiyTable()">{{ $t("Msg.Add") }}</el-button>
                                </el-form-item>
                                <el-form-item>
                                    <el-input v-model="SearchModel.Keyword" @input="GetDiyTable(true)" :placeholder="$t('Msg.Search')" class="input-left-borderbg" style="margin-top: 1px">
                                        <template #append><el-button :icon="Search" @click="GetDiyTable(true)"></el-button></template>
                                    </el-input>
                                </el-form-item>
                                <el-form-item>
                                    <el-dropdown trigger="click" @command="ChangeDataViewType">
                                        <el-button type="primary">
                                            切换视图<el-icon class="el-icon--right"><ArrowDown /></el-icon>
                                        </el-button>
                                        <template #dropdown
                                            ><el-dropdown-menu class="dropdown-big-button">
                                                <el-dropdown-item command="Card">
                                                    <el-icon class="icon mr-1"><Postcard /></el-icon>
                                                    卡片形式</el-dropdown-item
                                                >
                                                <el-dropdown-item command="Table">
                                                    <el-icon class="icon mr-1"><Grid /></el-icon>
                                                    表格形式</el-dropdown-item
                                                >
                                            </el-dropdown-menu></template
                                        >
                                    </el-dropdown>
                                </el-form-item>
                                <el-form-item>
                                    <el-select v-model="DbRealTableName" filterable placeholder="请选择非diy表">
                                        <el-option v-for="item in NotDiyTableList" :key="item" :label="item" :value="item"> </el-option>
                                    </el-select>
                                </el-form-item>
                                <el-form-item v-if="!DiyCommon.IsNull(DbRealTableName)">
                                    <el-button type="primary" :icon="Plus" :loading="btnLoading" @click="LoadNotDiyTable()">{{ $t("Msg.Load") }}</el-button>
                                </el-form-item>
                            </el-form>
                            <template v-if="DataViewType == 'Table'">
                                <el-table v-loading="tableLoading" :data="DiyTableList" style="width: 100%" class="diy-table no-border-outside" stripe border>
                                    <el-table-column type="index" width="50" />
                                    <el-table-column label="表名" width="180">
                                        <template #default="scope">
                                            {{ scope.row.Name }}
                                            <!-- .replace('Diy_', '') -->
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="Description" label="描述" />
                                    <el-table-column prop="CreateTime" :label="$t('Msg.CreateTime')" width="200" />
                                    <el-table-column fixed="right" :label="$t('Msg.Operation')" width="180">
                                        <template #default="scope">
                                            <el-button type="primary" class="marginRight5" :icon="QuestionFilled" @click="$router.push('/diy/diy-design/' + scope.row.Id)">{{
                                                $t("Msg.Design")
                                            }}</el-button>
                                            <el-dropdown trigger="click">
                                                <el-button>
                                                    {{ $t("Msg.More") }}<el-icon class="el-icon--right"><ArrowDown /></el-icon>
                                                </el-button>
                                                <template #dropdown
                                                    ><el-dropdown-menu class="table-more-btn">
                                                        <el-dropdown-item :icon="Edit" @click="OpenDiyTable(scope.row)">
                                                            {{ $t("Msg.Edit") }}
                                                        </el-dropdown-item>
                                                        <el-dropdown-item :icon="Edit" @click="OpenDiyTable(model, 'Copy', model.Name)">
                                                            {{ $t("Msg.Copy") }}
                                                        </el-dropdown-item>
                                                        <el-dropdown-item :icon="Delete" divided @click="DelDiyTable(scope.row)">
                                                            {{ $t("Msg.Delete") }}
                                                        </el-dropdown-item>
                                                    </el-dropdown-menu></template
                                                >
                                            </el-dropdown>
                                        </template>
                                    </el-table-column>
                                </el-table>
                                <el-pagination
                                    style="margin-top: 10px; float: left; margin-bottom: 10px; clear: both"
                                    background
                                    layout="total, sizes, prev, pager, next, jumper"
                                    :total="DiyTableCount"
                                    :page-size="DiyTablePageSize"
                                    :page-sizes="DiyCommon.PageSizes"
                                    @size-change="DiyTableSizeChange"
                                    @current-change="DiyTableCurrentChange"
                                />
                            </template>
                        </el-card>
                    </el-col>
                </el-row>
                <template v-if="DataViewType == 'Card'">
                    <el-row :gutter="20">
                        <el-skeleton style="width: 100%" :loading="tableLoading" animated>
                            <template #template>
                                <el-col :xs="24" :span="5" v-for="model in EmptyData" :key="model.Id" style="margin-top: 20px">
                                    <el-card class="box-card card-data-animate">
                                        <template #header
                                            ><div>
                                                <el-skeleton-item variant="text" style="width: 100%" /></div
                                        ></template>
                                        <div class="item">
                                            <el-skeleton-item />
                                        </div>
                                        <div class="item">
                                            <el-skeleton-item />
                                        </div>
                                        <div class="bottom-time">
                                            <el-skeleton-item variant="text" style="width: 100%" />
                                        </div>
                                    </el-card>
                                </el-col>
                            </template>
                            <el-col :xs="24" :span="5" v-for="model in DiyTableList" :key="model.Id" style="margin-top: 20px">
                                <el-card class="box-card card-data-animate">
                                    <template #header
                                        ><div style="position: relative">
                                            <span class="title">
                                                <el-icon><Document /></el-icon>
                                                {{ !DiyCommon.IsNull(model.Description) ? model.Description : model.Name }}</span
                                            >
                                            <div style="position: absolute; right: 0; top: 0; width: 120rpx; padding-left: 20rpx; background-color: #fff">
                                                <el-button type="text" class="marginRight5" :icon="QuestionFilled" @click="$router.push('/diy/diy-design/' + model.Id)">{{
                                                    $t("Msg.Design")
                                                }}</el-button>
                                                <el-dropdown trigger="click">
                                                    <el-button type="text">
                                                        {{ $t("Msg.More") }}<el-icon class="el-icon--right"><ArrowDown /></el-icon>
                                                    </el-button>
                                                    <template #dropdown
                                                        ><el-dropdown-menu class="table-more-btn">
                                                            <el-dropdown-item :icon="Edit" @click="OpenDiyTable(model)">
                                                                {{ $t("Msg.Edit") }}
                                                            </el-dropdown-item>
                                                            <el-dropdown-item :icon="Edit" @click="OpenDiyTable(model, 'Copy', model.Name)">
                                                                {{ $t("Msg.Copy") }}
                                                            </el-dropdown-item>
                                                            <el-dropdown-item :icon="Delete" divided @click="DelDiyTable(model)">
                                                                {{ $t("Msg.Delete") }}
                                                            </el-dropdown-item>
                                                        </el-dropdown-menu></template
                                                    >
                                                </el-dropdown>
                                            </div>
                                        </div></template
                                    >
                                    <div class="item">表名: {{ model.Name }}</div>
                                    <div class="item">
                                        打开方式:
                                        {{ DiyCommon.IsNull(model.FormOpenType) ? "Drawer" : model.FormOpenType }}
                                    </div>

                                    <div class="bottom-time">
                                        <el-icon><Clock /></el-icon> {{ model.CreateTime }}
                                        <div style="float: right; color: cadetblue" v-if="model.ReportId">虚拟表</div>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-skeleton>
                    </el-row>
                    <el-row>
                        <el-col :span="24">
                            <el-pagination
                                style="margin-top: 20px; float: left; margin-bottom: 10px; clear: both"
                                background
                                layout="total, sizes, prev, pager, next, jumper"
                                :total="DiyTableCount"
                                :page-size="DiyTablePageSize"
                                :page-sizes="DiyCommon.PageSizes"
                                @size-change="DiyTableSizeChange"
                                @current-change="DiyTableCurrentChange"
                            />
                        </el-col>
                    </el-row>
                </template>
            </el-tab-pane>
            <el-tab-pane :name="'Component'" :lazy="true">
                <template #label>
                    <span
                        ><el-icon><Setting /></el-icon> 组件</span
                    >
                </template>
                <DiyTable :ref="'refTableChild_DiyComponent'" :PropsTableId="'73a92e3d-8cd9-4a1f-bfc1-83fbc8e493d5'" :PropsSysMenuId="'d0c7a74a-2cfd-41c0-8902-440909f5f30c'" />
            </el-tab-pane>
        </el-tabs>
        <!-- <el-row
     id="openDiyTableModel"
     class="dialog-model"
     style="display:none;">
        <el-col :span="24">
            <el-form
               
                :model="CurrentDiyTableModel"
                >
                <el-form-item
                    label="表名"
                   >
                    <el-input v-model="CurrentDiyTableModel.Name" />
                </el-form-item>
                <el-form-item
                    label="描述"
                   >
                    <el-input v-model="CurrentDiyTableModel.Description" />
                </el-form-item>
            </el-form>
        </el-col>
    </el-row> -->
        <el-dialog draggable width="550px" :modal-append-to-body="false" v-model="ShowEditModel" :title="ShowEditModelTitle" :close-on-click-modal="false">
            <el-alert class="marginBottom15" title="表名建议固定前缀且小写，如：diy_tablename、microi_doc_paper" type="info" :closable="false" show-icon> </el-alert>
            <el-form :model="CurrentDiyTableModel" label-width="90px">
                <el-form-item label="表名">
                    <el-input v-model="CurrentDiyTableModel.Name" />
                </el-form-item>
                <el-form-item label="描述">
                    <el-input v-model="CurrentDiyTableModel.Description" />
                </el-form-item>
                <!-- <el-form-item
                label="所属数据库"
               >
                <el-select
                    v-model="CurrentDiyTableModel.DataBaseId"
                    filterable
                    @change="ChangeDataBase"
                    placeholder="默认主库">
                    <el-option
                    v-for="item in DataBaseList"
                    :key="item.Id"
                    :label="item.DbName"
                    :value="item.Id">
                    </el-option>
                </el-select>
            </el-form-item> -->
            </el-form>
            <template #footer>
                <el-button :loading="SaveDiyTableLoding" type="primary" :icon="QuestionFilled" @click="SaveDiyTable">{{ $t("Msg.Save") }}</el-button>
                <el-button :icon="Close" @click="ShowEditModel = false">{{ $t("Msg.Cancel") }}</el-button>
            </template>
        </el-dialog>
    </div>
</template>

<script>
// import DiyStore from '@/store/diy.store'
import _ from "underscore";
import { DiyApi, DiyTable } from "@/utils/microi.net.import";
export default {
    name: "diy_table",
    directives: {},
    components: {
        // DiyTable, //: (resolve) => require(['@/views/form-engine/diy-table'], resolve),
    },
    computed: {},
    data() {
        return {
            TableOpType: "",
            OldTableName: "",
            EmptyData: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
            DiyFormEngineTab: "Table", //Component
            btnLoading: false,
            DbRealTableName: "",
            NotDiyTableList: [],
            DataBaseList: [],

            SaveDiyTableLoding: false,
            tableLoading: true,
            ShowEditModelTitle: "",
            ShowEditModel: false,
            SearchModel: {
                Keyword: ""
            },
            DiyTableList: [],
            CurrentDiyTableModel: {
                Name: "diy_",
                DataBaseId: "",
                DataBaseName: ""
            },
            DiyTableCount: 0,
            DiyTablePageSize: 15,
            DiyTablePageIndex: 1,
            DataViewType: "Card" //Table
        };
    },
    mounted() {
        var self = this;
        var dataViewType = localStorage.getItem("Microi.DataViewType_" + "Diy_Table");
        if (!self.DiyCommon.IsNull(dataViewType)) {
            self.DataViewType = dataViewType;
        }
        self.GetDiyTable(true);
        self.GetNotDiyTable();
        // self.GetDataBaseList();
    },
    methods: {
        ChangeDataBase(val) {
            var self = this;
            if (val) {
                var name = self.DataBaseList.find((item) => {
                    return item.Id == val;
                });
                self.CurrentDiyTableModel.DataBaseName = name.DbName;
            } else {
                self.CurrentDiyTableModel.DataBaseName = "";
            }
        },
        GetDataBaseList() {
            var self = this;
            self.DiyCommon.FormEngine.GetTableData(
                {
                    FormEngineKey: "microi_database"
                },
                function (result) {
                    if (result.Code == 1) {
                        self.DataBaseList = result.Data;
                    }
                }
            );
        },
        GetNotDiyTable() {
            var self = this;
            self.DiyCommon.Post(DiyApi.GetNotDiyTable, {}, function (result) {
                if (result.Code == 1) {
                    self.NotDiyTableList = result.Data;
                }
            });
        },
        LoadNotDiyTable() {
            var self = this;
            self.btnLoading = true;
            self.DiyCommon.Post(
                DiyApi.LoadNotDiyTable,
                {
                    Name: self.DbRealTableName
                },
                function (result) {
                    if (self.DiyCommon.Result(result)) {
                        self.DbRealTableName = "";
                        self.GetDiyTable(true);
                        self.GetNotDiyTable();
                        self.DiyCommon.Tips(self.$t("Msg.Success"));
                    }
                    self.btnLoading = false;
                },
                function () {
                    self.btnLoading = false;
                }
            );
        },
        ChangeDataViewType(command) {
            var self = this;
            self.DataViewType = command;
            localStorage.setItem("Microi.DataViewType_" + "Diy_Table", command);
        },
        DiyTableCurrentChange(val) {
            var self = this;
            self.DiyTablePageIndex = val;
            self.GetDiyTable();
        },
        DiyTableSizeChange(val) {
            var self = this;
            self.DiyTablePageSize = val;
            self.DiyTablePageIndex = 1;
            self.GetDiyTable(true);
        },
        GetDiyTable(initPageIndex) {
            var self = this;
            if (initPageIndex === true) {
                self.DiyTablePageIndex = 1;
            }
            self.tableLoading = true;
            self.DiyCommon.Post(
                DiyApi.GetDiyTable,
                {
                    // OsClient: self.OsClient,
                    _PageSize: self.DiyTablePageSize,
                    _PageIndex: self.DiyTablePageIndex,
                    _Keyword: self.SearchModel.Keyword
                },
                function (result) {
                    self.tableLoading = false;
                    if (self.DiyCommon.Result(result)) {
                        self.DiyTableList = result.Data;
                        self.DiyTableCount = result.DataCount;
                    }
                }
            );
        },
        DelDiyTable(m) {
            var self = this;
            self.DiyCommon.OsConfirm(self.$t("Msg.ConfirmDelTo") + "【" + m.Name + "】？", function () {
                self.DiyCommon.Post(
                    DiyApi.DelDiyTable,
                    {
                        Id: m.Id
                    },
                    function (result) {
                        if (self.DiyCommon.Result(result)) {
                            self.DiyCommon.Tips(self.$t("Msg.Success"));
                            self.GetDiyTable();
                        }
                    }
                );
            });
        },
        OpenDiyTable(m, type, oldTableName) {
            var self = this;
            self.TableOpType = type;
            self.OldTableName = oldTableName;
            var url = DiyApi.UptDiyTable;
            var title = self.$t("Msg.Add");
            if (self.TableOpType == "Copy") {
                title = "复制表";
                self.CurrentDiyTableModel = m;
            } else if (self.DiyCommon.IsNull(m)) {
                self.CurrentDiyTableModel = {
                    Name: "diy_"
                };
                url = DiyApi.AddDiyTable;
            } else {
                title = m.Name;
                // m.Name = m.Name.replace('Diy_', '')
                self.CurrentDiyTableModel = m;
            }
            self.ShowEditModelTitle = title;
            self.ShowEditModel = true;
        },
        async SaveDiyTable() {
            var self = this;
            try {
                self.SaveDiyTableLoding = true;
                if (self.TableOpType == "Copy") {
                    var copyResult = await self.DiyCommon.ApiEngine.Run("copy_table", {
                        TableId: self.CurrentDiyTableModel.Id,
                        TableName: self.CurrentDiyTableModel.Name,
                        Description: self.CurrentDiyTableModel.Description
                    });
                    self.SaveDiyTableLoding = false;
                    if (self.DiyCommon.Result(copyResult)) {
                        self.DiyCommon.Tips(self.$t("Msg.Success"));
                        self.GetDiyTable(true);
                        self.ShowEditModel = false;
                    }
                    return;
                }
                var url = "/api/DiyTable/UptDiyTable";
                if (self.DiyCommon.IsNull(self.CurrentDiyTableModel.Id)) {
                    url = "/api/DiyTable/AddDiyTable";
                }
                var { ...param } = self.CurrentDiyTableModel;
                // param.OsClient = self.OsClient
                self.DiyCommon.Post(url, param, function (result) {
                    self.SaveDiyTableLoding = false;
                    if (self.DiyCommon.Result(result)) {
                        self.DiyCommon.Tips(self.$t("Msg.Success"));
                        self.GetDiyTable(true);
                        self.ShowEditModel = false;
                    }
                });
            } catch (error) {
                console.log(error);
                self.SaveDiyTableLoding = false;
            }
        }
    }
};
</script>

<style>
.card-data-animate .title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: calc(100% - 180rpx);
    display: inline-block;
}

.card-data-animate .item {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}
</style>
