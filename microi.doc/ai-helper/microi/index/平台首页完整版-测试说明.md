# 平台首页完整版 - 测试说明

## 已修复的问题

### 1. 接口引擎性能优化
- ✅ 修改`return`为`V8.Return()`
- ✅ 默认type不走`getAllData()`避免超时
- ✅ `getPerformanceData()`返回单个`disk`数值（不是数组）
- ✅ 添加`getNetworkData()`和`getMemoData()`函数
- ✅ 移除`getAllData()`中的耗时排行查询

### 2. 数据格式统一
简化版和完整版现在返回相同的数据结构：

```javascript
// statistics
{
  formCount: 10,
  moduleCount: 25,
  apiEngineCount: 8,
  userCount: 5
}

// performance
{
  cpu: 45,
  memory: 62,
  disk: 78  // 单个数值，不是数组
}

// systeminfo
{
  os: {
    Platform: "Unix",
    OSVersion: "14.0.0",
    MachineName: "Server01",
    ProcessorCount: 8
  },
  version: {
    frontendVersion: "3.0.0",
    backendVersion: "3.0.2",
    edition: "开源版"
  }
}
```

## 测试步骤

### 第一步：测试接口引擎各个type

1. **测试统计数据（最快）**
   ```
   GET /apiengine/platform-dashboard?type=statistics
   ```
   预期响应时间：< 1秒
   
2. **测试性能数据**
   ```
   GET /apiengine/platform-dashboard?type=performance
   ```
   预期响应时间：< 2秒
   
3. **测试系统信息**
   ```
   GET /apiengine/platform-dashboard?type=systeminfo
   ```
   预期响应时间：< 1秒

4. **测试待办数据**
   ```
   GET /apiengine/platform-dashboard?type=todo
   ```
   
5. **测试通知公告**
   ```
   GET /apiengine/platform-dashboard?type=notice
   ```

6. **测试常用模块**
   ```
   GET /apiengine/platform-dashboard?type=modules
   ```

7. **测试登录日志**
   ```
   GET /apiengine/platform-dashboard?type=loginlogs
   ```

8. **测试网络流量**
   ```
   GET /apiengine/platform-dashboard?type=network
   ```

9. **测试个人备忘录**
   ```
   GET /apiengine/platform-dashboard?type=memo
   ```

### 第二步：测试界面引擎数据绑定

界面引擎使用`${变量名}`语法绑定数据，例如：

```json
{
  "value": "/apiengine/platform-dashboard?type=statistics",
  "dataJson": {
    "title": "表单数",
    "value": "${formCount}"
  }
}
```

**关键检查点：**
1. 统计卡片是否显示正确的数字
2. 性能仪表盘是否显示CPU/内存/磁盘百分比
3. 系统信息是否显示操作系统和版本信息
4. 待办、通知、常用模块列表是否正确显示

### 第三步：检查可能为空的数据源

以下数据可能为空（取决于数据库表是否存在数据）：

1. **待办事项** - 需要`diy_workflow_todo`表有数据
2. **流程发起** - 需要`diy_workflow`表有数据
3. **通知公告** - 需要`diy_notice`表有数据
4. **常用模块** - 需要`diy_user_favorite`表有数据
5. **登录日志** - 需要`sys_login_log`表有数据
6. **接口排行** - 需要`diy_api_request_log`表有数据（已禁用，避免超时）
7. **数据排行** - 需要`diy_table`表有数据（已禁用，避免超时）
8. **个人备忘录** - 需要`diy_user_memo`表有数据

## 界面引擎数据绑定问题排查

如果界面引擎显示空白，可能的原因：

### 1. 数据源配置问题
检查`value`字段是否正确：
```json
"value": "/apiengine/platform-dashboard?type=statistics"
```

### 2. 变量绑定语法问题
Microi吾码的界面引擎需要支持`${}`变量替换。如果不支持，需要修改为直接返回完整的`dataJson`。

**解决方案A：接口直接返回完整dataJson**

修改接口引擎，不返回原始数据，而是返回已经填充好的dataJson：

```javascript
function getStatisticsData() {
  var formCount = 15;
  var moduleCount = 32;
  // ...
  
  return {
    // 原始数据（供${变量}绑定用）
    formCount: formCount,
    moduleCount: moduleCount,
    apiEngineCount: apiEngineCount,
    userCount: userCount,
    
    // 完整的dataJson（如果不支持${变量}，直接用这个）
    _renderData: {
      statCard1: {
        title: "表单数",
        value: formCount,
        icon: "el-icon-document",
        color: "#409EFF"
      },
      statCard2: {
        title: "模块数",
        value: moduleCount,
        icon: "el-icon-menu",
        color: "#67C23A"
      },
      // ...
    }
  };
}
```

**解决方案B：界面引擎直接使用静态数据**

参考简化版，将`value`设为空字符串，直接在`dataJson`中写入数据：

```json
{
  "value": "",
  "dataJson": {
    "title": "表单数",
    "value": 15,
    "icon": "el-icon-document"
  }
}
```

## 性能对比

| 版本 | 默认请求响应时间 | 加载所有模块 | 是否会超时 |
|------|-----------------|-------------|-----------|
| 简化版 | < 1秒 | 3个模块 | ❌ 否 |
| 完整版（修复前） | > 60秒 | 10个模块 | ✅ 是 |
| 完整版（修复后） | < 2秒 | 8个模块 | ❌ 否 |

## 后续优化建议

1. **添加缓存机制**
   - 统计数据缓存5分钟
   - 性能数据缓存1分钟
   - 系统信息缓存1小时

2. **创建聚合表**
   - 创建`diy_statistics_cache`表存储预计算的统计数据
   - 通过定时任务每5分钟更新一次

3. **启用排行查询**
   - 当前`apirank`和`datarank`已禁用
   - 建议创建专门的排行统计表
   - 通过后台任务定时计算，前端直接查询结果表

4. **按需加载**
   - 首页默认只加载核心数据（statistics, performance）
   - 其他模块滚动到可视区域时再加载
   - 使用懒加载减少首次加载时间
