# Report Engine

## Introduction
The report engine is implemented by the combination of [Data Source Engine Interface Engine Form Engine Module Engine]. Currently, only table presentation is supported,`ECharts`Graphic presentation forms are under development.

## Feature Highlights
1. Fully customized add, delete, modify and query are supported: general statistical report data comes from multiple tables, and multiple tables may need to be operated when adding, modifying and deleting, which can be implemented through interface engine transactions.
2. All reports will generate virtual`diy_table`Table, Virtual`diy_field`Field
3. The report supports independent form design (virtual field)
4. Support [Module Engine] to configure query columns, editable columns, searchable columns, etc.

## Create a tabular report

1. Create a data source engine. Currently, a report engine requires a data source engine to provide data source support. Data source support`SQLã€V8ã€JSON`(If the data source type of the old version contains Chinese, please modify the capital letters for this three items)
2. Create a report engine. Select the corresponding data source, save it and then configure the fields to be displayed.
3. Add a module to [Module Engine DIY] and select [DIY] as the opening method]. and select the virtual report that was just automatically generated
4. In the design of [Report Engine], modify [Query Interface Replacement, Add Interface Replacement, Modify Interface Replacement, Delete Interface Replacement] to the corresponding implementation interface of the interface engine (for example, replace:`/apiengine/get_webuser_info`)

## Implementation effect display

The customer is a small program of the mall, and points can be obtained by shopping on the small program. This report records the points consumption statistics of the number of points consumption orders generated by each merchant.

You can search and filter by the name of the head merchant and the order time, and dynamically count the points order statistics within a given time.


! [Report Engine](/api_plugins/report01.png)

## Implementation steps

### Add Data Source Engine
Add a new data source to the data source engine to count the data in the report. The implementation code is as follows:

```js
// åˆ†é¡µå‚æ•°
var pageIndex = V8.Param._PageIndex || 1;
var pageSize = V8.Param._PageSize || 15;
var PageNum = 0
if (pageIndex > 1) {
  PageNum = pageSize * (pageIndex - 1)
}
 
// æœç´¢æ¡ä»¶
var ShanghuMC = ''
var _Where = V8.Param._Where || '';
if(_Where){
  _Where = JSON.parse(_Where)
  _Where.forEach(item=>{
    if(item.Name == 'ShanghuMC') ShanghuMC = item.Value
  })
}
// å…³é”®è¯æœç´¢
var _Keyword = ''
if(V8.Param._Keyword){
  _Keyword = V8.Param._Keyword
}
// æ—¶é—´æœç´¢æ¡ä»¶
var KaishiSJ = ''
var JieshuSJ = ''
var where1 = ''
if(V8.Param._SearchDateTime){
  var ShijianFW = V8.Param._SearchDateTime.ShijianFW
  if(ShijianFW){
    KaishiSJ = ShijianFW[0]
    JieshuSJ = ShijianFW[1]
    KaishiSJ = `${KaishiSJ} 00:00:00`
    JieshuSJ = `${JieshuSJ} 23:59:59`
    where1 = `and CreateTime >= '${KaishiSJ}' and CreateTime <= '${JieshuSJ}'`
  }
  
}
 
// ç»Ÿè®¡æ€»å…±çš„æ¡æ•°
var Count =  V8.Db.FromSql(`select count(Id) from diy_shanghuGL where IsDeleted = 0 and ShenheZT = 'å·²é€šè¿‡' and ShangjiaZT = 'ä¸Šæž¶' and ShanghuMC Like '%${ShanghuMC}%' and ShanghuMC Like '%${_Keyword}%'`).ToScalar()
 
// èŽ·å–ä¸»æ•°æ®
var ShanghuInfo = V8.Db.FromSql(`select * from diy_shanghuGL where IsDeleted = 0 and ShenheZT = 'å·²é€šè¿‡' and ShangjiaZT = 'ä¸Šæž¶' and ShanghuMC Like '%${ShanghuMC}%' and ShanghuMC Like '%${_Keyword}%'  limit ${PageNum},${pageSize} `).ToArray()
var data = []
 
// å†™ä»£ç é€»è¾‘èŽ·å–éœ€è¦çš„å†…å®¹
ShanghuInfo.forEach(item=>{
  var FuzeR = V8.Db.FromSql(`select * from sys_user where Id = '${item.FuzeRID}'`).ToArray();
  FuzeR = FuzeR[0];
  var obj = {
    ShanghuMC:item.ShanghuMC,
    FuzeRXM : FuzeR.Name || FuzeR.Account,
    FuzeR : FuzeR.Account,
    YonghuID : FuzeR.Id,
    ShanghuSK : 0,
    DingDanShu:0,
    ShanghuID : item.Id,
    ShanghuLOGO : item.ShanghuLOGO
  }
// æ¶ˆè´¹ç§¯åˆ†ç»Ÿè®¡
  obj.ShanghuSK = V8.Db.FromSql(`select sum(XiaofeiJF) from diy_JFXFMX where IsDeleted =0 and (HexiaoZT = 'å·²å®Œæˆ' or HexiaoZT = 'å¾…è¯„ä»·' ) and ShanghuID = '${item.Id}' ` + where1).ToScalar()
  obj.ShanghuSK = obj.ShanghuSK || 0
// è®¢å•æ•°ç»Ÿè®¡
  obj.DingDanShu = V8.Db.FromSql(`select Count(Id) from diy_JFXFMX where IsDeleted =0 and (HexiaoZT = 'å·²å®Œæˆ' or HexiaoZT = 'å¾…è¯„ä»·' ) and ShanghuID = '${item.Id}' ` + where1).ToScalar()
  data.push(obj)
})
 
 
V8.Result = { Code : 1, Data : data, DataCount : Count}
```

### Report Add

! [Report Engine](/api_plugins/report02.png)

### Design Report
After adding a report, click Report Design to enter the corresponding form design area.

! [Report Engine](/api_plugins/report03.png)

You can select the required space on the left and drag it to the middle form area. The form properties on the right can set the field properties of the control.
You can also pull in the required search condition controls as required, and configure the search condition code in the process engine as well.

>>ðŸŒˆNote: The field name must correspond to the data obtained from the process engine.

! [Report Engine](/api_plugins/report04.png)

ðŸŒˆNote: You can also select fields in an existing table or add all fields in the table by field configuration.

![æŠ¥è¡¨å¼•æ“Ž](/api_plugins/report05.png)

## Module engine assigns reports to pages

1. If you need to add a secondary menu, open the selection`SecondMenu`, add form selection`Diy`.
2. Select the newly added report in the custom table and search in the interface template`+`Form.
3. Sort is the sort order in this parent menu. The smaller the order, the higher the order. The default is`0`.

![æŠ¥è¡¨å¼•æ“Ž](/api_plugins/report06.png)

## permission assignment

1. In Position Roles, select the role that needs to see this report.
2. Check its check box in the corresponding menu.
3. Click Save.
4. Refresh the browser to see the report engine you just assigned.

![æŠ¥è¡¨å¼•æ“Ž](/api_plugins/report07.png)