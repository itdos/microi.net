var V=Object.defineProperty;var $=(d,e,t)=>e in d?V(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var H=(d,e,t)=>$(d,typeof e!="symbol"?e+"":e,t);import{X,i as q,h as Y,l as g,E as U,s as Z,L as _,M as J,N as K,B as Q,u as ee,O as te}from"./main-DrxgF003.js";import{a3 as ie,ax as se,a6 as ae,a7 as ne,a8 as y,a9 as oe,aa as re,ab as le,ac as he,ad as ce,x as de,ae as A,ag as me,ah as pe,f as v,ai as ue,af as ge,e as E,aj as D,G as R,al as L,au as T,C as u,c as fe,L as C,av as we,ak as Le,W as B,u as Ce,V as k,T as b,E as be,t as F,o as W,am as Me,an as xe,r as z,ao as Pe,ap as Se,aq as ye,ar as Ae,as as Ee,a0 as Re,D as Fe,a1 as ze,a2 as He,A as ve}from"./DRACOLoader-DSa8Sn_h.js";import{b as De,E as O,c as j,O as Te,d as Be,S as G,F as ke,e as We,f as Oe,v as je,R as Ge,C as Ie}from"./RGBELoader-DNv9Vp1K.js";function Ne(d){return typeof d=="function"||Object.prototype.toString.call(d)==="[object Object]"&&!te(d)}const Ve=ee(),{mapImageList:I}=Z(Ve);class $e{constructor(e,t){H(this,"onWindowResize",()=>{const{clientHeight:e,clientWidth:t}=this.container,s=this.renderer.getPixelRatio();if(this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.css3DRenderer.setSize(t,e),this.effectComposer){const i=this.effectComposer.passes[3];i&&i.uniforms&&i.uniforms.resolution.value.set(1/(t*s),1/(e*s)),this.effectComposer.setSize(t,e)}this.glowComposer&&this.glowComposer.setSize(t,e)});this.config=e,this.container=document.querySelector("#"+t),this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.model=null,this.fileLoaderMap={glb:new y,fbx:new oe(this.loadingManager),gltf:new y,obj:new ne(this.loadingManager),stl:new ae},this.modelAnimation=null,this.animationMixer=null,this.animationClock=new re,this.animationFrame=null,this.rotationAnimationFrame=null,this.animateClipAction=null,this.loopMap={LoopOnce:ce,LoopRepeat:he,LoopPingPong:le},this.gridHelper=null,this.axesHelper=null,this.planeGeometry=null,this.modelMaterialList=null,this.modelTextureMap=null,this.glowMaterialList=null,this.materials={},this.effectComposer=null,this.outlinePass=null,this.renderAnimation=null,this.glowComposer=null,this.unrealBloomPass=null,this.shaderPass=null,this.raycaster=new de,this.mouse=new A,this.onWindowResizesListener=null,this.onMouseMoveListener=null,this.css3dControls=null,this.css3DRenderer=null}async init(){try{this.initRender(),this.initCamera(),this.initScene(),this.initControls();const e=await this.loadModel(this.config.fileInfo);return await Promise.all([this.createEffectComposer(),this.setSceneBackground(),this.setModelMaterial(),this.setModelLaterStage(),this.setSceneLight(),this.setModelAnimation(),this.setModelAxleLine(),this.setSceneTagsRender()]),this.sceneAnimation(),this.addEvenListMouseListener(),e}catch(e){throw console.error("初始化3D场景失败:",e),e}}initRender(){this.renderer=new me({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio);const{clientHeight:e,clientWidth:t}=this.container;this.renderer.setSize(t,e),this.renderer.toneMapping=pe,this.renderer.autoClear=!0,this.renderer.outputColorSpace=v,this.renderer.toneMappingExposure=1,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=ue,this.container.appendChild(this.renderer.domElement),this.css3DRenderer=new De,this.css3DRenderer.setSize(t,e),this.css3DRenderer.domElement.style.position="absolute",this.css3DRenderer.domElement.style.pointerEvents="none",this.css3DRenderer.domElement.style.top=0}initCamera(){const{clientHeight:e,clientWidth:t}=this.container;this.camera=new ge(50,t/e,.05,1e4);const{camera:s}=this.config;if(!s)return!1;const{x:i,y:n,z:a}=s;this.camera.position.set(i,n,a),this.camera.updateProjectionMatrix()}initScene(){this.scene=new E}addEvenListMouseListener(){this.onWindowResizesListener=this.onWindowResize,window.addEventListener("resize",this.onWindowResizesListener)}initControls(){this.controls=new D(this.camera,this.renderer.domElement),this.controls.enablePan=!0,this.controls.enableDamping=!0,this.controls.target.set(0,0,0),this.css3dControls=new D(this.camera,this.css3DRenderer.domElement),this.css3dControls.enablePan=!1,this.css3dControls.enabled=!1,this.css3dControls.enableDamping=!1,this.css3dControls.target.set(0,0,0),this.css3dControls.update()}sceneAnimation(){this.renderAnimation=requestAnimationFrame(()=>this.sceneAnimation());const{stage:e,tags:t}=this.config;e&&e.glow?this.setMeshFlow():(this.effectComposer.render(),this.controls.update()),t&&t.dragTagList.length&&(this.css3DRenderer.render(this.scene,this.camera),this.css3dControls.update())}setMeshFlow(){this.scene.traverse(e=>{e instanceof R&&(this.materials.gridHelper=e.material,e.material=new L({color:"#000"})),e instanceof E&&(this.materials.scene=e.background,this.materials.environment=e.environment,e.background=null,e.environment=null),!this.glowMaterialList.includes(e.name)&&e.isMesh&&(this.materials[e.uuid]=e.material,e.material=new L({color:"#000"}))}),this.glowComposer.render(),this.scene.traverse(e=>{this.materials[e.uuid]&&(e.material=this.materials[e.uuid],delete this.materials[e.uuid]),e instanceof R&&(e.material=this.materials.gridHelper,delete this.materials.gridHelper),e instanceof E&&(e.background=this.materials.scene,e.environment=this.materials.environment,delete this.materials.scene,delete this.materials.environment)}),this.effectComposer.render(),this.controls.update()}createEffectComposer(){const{clientHeight:e,clientWidth:t}=this.container,s=this.renderer.getPixelRatio(),i=new A(t,e);this.effectComposer=new O(this.renderer,new T(t,e,{samples:4}));const n=new j(this.scene,this.camera);this.effectComposer.addPass(n),this.outlinePass=new Te(i,this.scene,this.camera),this.configureOutlinePass(),this.effectComposer.addPass(this.outlinePass),this.effectComposer.addPass(new Be);const a=new G(ke);a.uniforms.resolution.value.set(1/(t*s),1/(e*s)),a.renderToScreen=!0,a.needsSwap=!0,a.material.uniforms.tDiffuse.value=1,a.enabled=!0,this.effectComposer.addPass(a),this.setupBloomEffect(t,e),this.setupShaderPass()}configureOutlinePass(){this.outlinePass.visibleEdgeColor=new u("#FF8C00"),this.outlinePass.hiddenEdgeColor=new u("#8a90f3"),this.outlinePass.edgeGlow=2,this.outlinePass.edgeThickness=1,this.outlinePass.edgeStrength=4,this.outlinePass.pulsePeriod=100}setupBloomEffect(e,t){this.unrealBloomPass=new We(new A(e,t),0,0,0);const s=new T(e*2,t*2,{minFilter:C,magFilter:C,format:fe,stencilBuffer:!1});this.glowComposer=new O(this.renderer,s),this.glowComposer.renderToScreen=!1,this.glowComposer.addPass(new j(this.scene,this.camera)),this.glowComposer.addPass(this.unrealBloomPass)}setupShaderPass(){this.shaderPass=new G(new we({uniforms:{baseTexture:{value:null},bloomTexture:{value:this.glowComposer.renderTarget2.texture},tDiffuse:{value:null},glowColor:{value:new u}},vertexShader:je,fragmentShader:Oe,defines:{}}),"baseTexture"),this.shaderPass.renderToScreen=!0,this.shaderPass.needsSwap=!0,this.effectComposer.addPass(this.shaderPass)}loadModel({filePath:e,fileType:t,map:s,scale:i}){return new Promise((n,a)=>{let o;if(["glb","gltf"].includes(t)){const r=new Le;r.setDecoderPath("draco/gltf/"),r.setDecoderConfig({type:"js"}),r.preload(),o=new y().setDRACOLoader(r)}else o=this.fileLoaderMap[t];o.load(e,r=>{switch(t){case"glb":this.model=r.scene;break;case"fbx":this.model=r;break;case"gltf":this.model=r.scene;break;case"obj":this.model=r;break;case"stl":const l=new L,c=new B(r,l);this.model=c;break}this.getModelMaterialList(s),this.modelAnimation=r.animations||[],this.setModelPositionSize(i),this.glowMaterialList=this.modelMaterialList.map(l=>l.name),this.scene.add(this.model),n(!0)},()=>{},r=>{U.error("文件错误"),console.log(r),a()})})}onClearModelData(){var t,s,i,n,a;[this.rotationAnimationFrame,this.renderAnimation,this.animationFrame].forEach(o=>{o&&cancelAnimationFrame(o)}),this.scene.traverse(o=>{var r,l;o.type==="Mesh"&&((r=o.geometry)==null||r.dispose(),(l=o.material)==null||l.dispose())}),[this.gridHelper,this.axesHelper].forEach(o=>{o&&(o.clear(),o.dispose())}),[this.effectComposer,this.glowComposer].forEach(o=>{o==null||o.dispose()}),(t=this.container)==null||t.removeEventListener("mousemove",this.onMouseMoveListener),window.removeEventListener("resize",this.onWindowResizesListener),(s=this.scene)==null||s.clear(),(i=this.renderer)==null||i.clear(),(n=this.renderer)==null||n.dispose(),(a=this.camera)==null||a.clear(),["config","container","camera","scene","renderer","controls","model","fileLoaderMap","modelAnimation","animationMixer","animationClock","animationFrame","rotationAnimationFrame","animateClipAction","loopMap","gridHelper","axesHelper","planeGeometry","modelMaterialList","effectComposer","outlinePass","renderAnimation","raycaster","mouse","modelTextureMap","glowComposer","unrealBloomPass","shaderPass","glowMaterialList","materials","css3dControls","css3DRenderer"].forEach(o=>{this[o]=null})}setModelPositionSize(e){console.log("预览触发"),this.model.updateMatrixWorld();const t=new Ce().setFromObject(this.model),s=t.getSize(new k),i=t.getCenter(new k),n=Math.max(s.x,s.y,s.z);e=e||2.5;const a=e/(n>1?n:.5);this.model.scale.set(a,a,a),this.model.position.sub(i.multiplyScalar(a)),this.controls.maxDistance=s.length()*10,this.camera.updateProjectionMatrix()}getModelMaterialList(){this.modelMaterialList=[],this.model.traverse(e=>{if(e.isMesh&&(e.castShadow=!0,e.frustumCulled=!1,e.material)){const t=e.material.clone();e.material=t,this.modelMaterialList.push(e)}})}async setSceneBackground(){const{background:e}=this.config;if(!e)return!1;if(e.visible){const{color:t,image:s,viewImg:i,intensity:n,blurriness:a,type:o=3}=e;switch(o){case 1:this.scene.background=new u(t);break;case 2:const r=new b().load(s);this.scene.background=r,r.dispose();break;case 3:let l;i.endsWith(".hdr")?l=await new Ge().loadAsync(i):l=await new b().loadAsync(i),l.mapping=be,this.scene.background=l,this.scene.environment=l,this.scene.backgroundIntensity=n,this.scene.backgroundBlurriness=a,l.dispose();break}}else this.scene.background=new u("#000")}setModelMaterial(){const{material:e}=this.config;if(!e||!e.meshList)return!1;const t=I.value.map(s=>s.id);e.meshList.forEach(s=>{const i=this.model.getObjectByProperty("name",s.meshName);if(!i)return!1;const{color:n,opacity:a,depthWrite:o,wireframe:r,visible:l,type:c}=s,{map:m}=(i==null?void 0:i.material)||{};if(e.materialType&&m?i.material=new F[c]({map:m}):i.material&&(i.material.map=m),s.meshFrom)if(t.includes(s.meshFrom)){const p=I.value.find(f=>f.id==s.meshFrom)||{},h=new b().load(p.url);h.wrapS=W,h.wrapT=W,h.flipY=!1,h.colorSpace=v,h.minFilter=C,h.magFilter=C,e.materialType?i.material=new F[c]({map:h}):i.material.map=h,h.dispose()}else{const p=this.model.getObjectByProperty("name",s.meshFrom),{map:h}=p.material;e.materialType?i.material=new F[c]({map:h}):i.material.map=h}i.material.visible=l,i.material.color.set(new u(n)),i.material.wireframe=r,i.material.depthWrite=o,i.material.transparent=!0,i.material.opacity=a})}setModelLaterStage(){const{stage:e}=this.config;if(!e)return!1;const{threshold:t,strength:s,radius:i,toneMappingExposure:n,meshPositionList:a,color:o}=e;e.glow?(this.unrealBloomPass.threshold=t,this.unrealBloomPass.strength=s,this.unrealBloomPass.radius=i,this.renderer.toneMappingExposure=n,this.shaderPass.material.uniforms.glowColor.value=new u(o)):(this.unrealBloomPass.threshold=0,this.unrealBloomPass.strength=0,this.unrealBloomPass.radius=0,this.renderer.toneMappingExposure=n,this.shaderPass.material.uniforms.glowColor.value=new u),a.forEach(r=>{const l=this.model.getObjectByProperty("name",r.name);if(!l)return;const{rotation:c,scale:m,position:p}=r;l.rotation.set(c.x,c.y,c.z),l.scale.set(m.x,m.y,m.z),l.position.set(p.x,p.y,p.z)})}setSceneLight(){const{light:e}=this.config;if(!e)return!1;if(e.ambientLight){const t=new Me(e.ambientLightColor,e.ambientLightIntensity);t.visible=e.ambientLight,this.scene.add(t)}if(e.directionalLight){const t=new xe(e.directionalLightColor,e.directionalLightIntensity),{x:s,y:i,z:n}=z(e.directionalHorizontal,e.directionalVertical,e.directionalSistine);t.position.set(s,i,n),t.castShadow=e.directionShadow,t.visible=e.directionalLight,this.scene.add(t);const a=new Pe(t,.5);a.visible=e.directionalLightHelper,this.scene.add(a)}if(e.pointLight){const t=new Se(e.pointLightColor,e.pointLightIntensity,100);t.visible=e.pointLight;const{x:s,y:i,z:n}=z(e.pointHorizontal,e.pointVertical,e.pointDistance);t.position.set(s,i,n),this.scene.add(t);const a=new ye(t,.5);a.visible=e.pointLightHelper,this.scene.add(a)}if(e.spotLight){const t=new Ae(e.spotLightColor,900);t.visible=e.spotLight;const s=new b().load("model-bg/model-bg-1.jpg");s.dispose(),t.map=s,t.decay=2,t.shadow.mapSize.width=1920,t.shadow.mapSize.height=1080,t.shadow.camera.near=1,t.shadow.camera.far=10,t.intensity=e.spotLightIntensity,t.angle=e.spotAngle,t.penumbra=e.spotPenumbra,t.shadow.focus=e.spotFocus,t.castShadow=e.spotCastShadow,t.distance=e.spotDistance;const{x:i,y:n,z:a}=z(e.spotHorizontal,e.spotVertical,e.spotSistine);t.position.set(i,n,a),this.scene.add(t);const o=new Ee(t);o.visible=e.spotLightHelper&&e.spotLight,this.scene.add(o)}if(e.planeGeometry){const t=new Re(e.planeWidth,e.planeHeight);let s=new L({color:e.planeColor});const i=new B(t,s);i.rotation.x=-Math.PI/2,i.position.set(0,-1.2,0),i.visible=e.planeGeometry,i.material.side=Fe,i.geometry.verticesNeedUpdate=!0,i.receiveShadow=!0,this.scene.add(i)}}setModelAnimation(){const{animation:e}=this.config;if(!e)return!1;if(this.modelAnimation.length&&e&&e.visible){this.animationMixer=new ze(this.model);const{animationName:t,timeScale:s,weight:i,loop:n}=e,a=He.findByName(this.modelAnimation,t);a&&(this.animateClipAction=this.animationMixer.clipAction(a),this.animateClipAction.setEffectiveTimeScale(s),this.animateClipAction.setEffectiveWeight(i),this.animateClipAction.setLoop(this.loopMap[n]),this.animateClipAction.play()),this.animationFrameFun()}if(e.rotationVisible){const{rotationType:t,rotationSpeed:s}=e;this.rotationAnimationFun(t,s)}}animationFrameFun(){this.animationFrame=requestAnimationFrame(()=>this.animationFrameFun()),this.animationMixer&&this.animationMixer.update(this.animationClock.getDelta())}rotationAnimationFun(e,t){this.rotationAnimationFrame=requestAnimationFrame(()=>this.rotationAnimationFun(e,t)),this.model.rotation[e]+=t/50}setModelAxleLine(){const{attribute:e}=this.config;if(!e)return!1;const{axesHelper:t,axesSize:s,color:i,divisions:n,gridHelper:a,positionX:o,positionY:r,positionZ:l,size:c,visible:m,x:p,y:h,z:f,rotationX:M,rotationY:x,rotationZ:w}=e;if(!m)return!1;this.gridHelper=new R(c,n,i,i),this.gridHelper.position.set(p,h,f),this.gridHelper.visible=a,this.gridHelper.material.linewidth=.1,this.scene.add(this.gridHelper),this.axesHelper=new ve(s),this.axesHelper.visible=t,this.axesHelper.position.set(0,-.5,0),this.scene.add(this.axesHelper),this.model.position.set(o,r,l),this.model.rotation.set(M,x,w),this.renderer.shadowMap.enabled=!0}setSceneTagsRender(){var s;const{tags:e}=this.config;if(!((s=e==null?void 0:e.dragTagList)!=null&&s.length))return;this.container.appendChild(this.css3DRenderer.domElement);const t=i=>{const{backgroundColor:n,color:a,fontSize:o,height:r,iconColor:l,iconName:c,iconSize:m,innerText:p,positionX:h,positionY:f,positionZ:M,width:x}=i,w=document.createElement("div"),N=_({render(){let S;return g("div",null,[g("div",{className:"element-tag",style:{width:`${x}px`,height:`${r}px`,fontSize:`${o}px`,color:a,backgroundColor:n,boxShadow:`0px 0px 4px ${n}`}},[g("span",{className:"tag-txt"},[p])]),g("div",{className:"tag-icon",style:{fontSize:`${m}px`,color:l}},[g(J,null,Ne(S=K(Q[c]))?S:{default:()=>[S]})])])}}).mount(document.createElement("div"));w.appendChild(N.$el);const P=new Ie(w);return P.position.set(h,f,M),P.scale.set(.01,.01,.01),P};e.dragTagList.forEach(i=>{const n=t(i);this.scene.add(n)})}}function _e(d){const e=`three-model-${ie(5,10)}`;let t=null;return X({name:"ThreeDComponent",props:{width:[String,Number],height:[String,Number]},data:()=>({loading:!1}),watch:{$props:{handler:()=>{t!=null&&t.onWindowResize&&se(t.onWindowResize,200)()},deep:!0}},async mounted(){try{this.loading=!0,t=new $e(d,e),await t.init()}catch(s){console.error("3D模型加载失败:",s)}finally{this.loading=!1}},beforeUnmount(){t==null||t.onClearModelData(),t=null},render(){const s={width:this.width?`${this.width-10}px`:"100%",height:this.height?`${this.height-10}px`:"100%",pointerEvents:this.width&&this.height?"none":void 0};return q(g("div",{id:e,style:s},null),[[Y("zLoading"),this.loading]])}})}export{_e as c};
